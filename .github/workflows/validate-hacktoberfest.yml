name: Validate Hacktoberfest Setup

on:
  workflow_dispatch: # Manual trigger
  schedule:
    - cron: '0 0 * * 0' # Weekly on Sundays

permissions:
  issues: write
  pull-requests: write
  contents: read

jobs:
  validate-setup:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Validate Hacktoberfest configuration
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          console.log('ğŸ” Validating Hacktoberfest setup...');
          
          // Check if required labels exist
          const requiredLabels = [
            'hacktoberfest',
            'hacktoberfest-accepted',
            'good first issue',
            'help wanted'
          ];
          
          const { data: labels } = await github.rest.issues.listLabelsForRepo({
            owner: context.repo.owner,
            repo: context.repo.repo
          });
          
          const existingLabels = labels.map(label => label.name);
          const missingLabels = requiredLabels.filter(label => !existingLabels.includes(label));
          
          if (missingLabels.length > 0) {
            console.log(`âŒ Missing required labels: ${missingLabels.join(', ')}`);
            
            // Create missing labels
            const labelConfigs = {
              'hacktoberfest': { color: 'FF6B35', description: 'Issues/PRs for Hacktoberfest participation' },
              'hacktoberfest-accepted': { color: '9C4668', description: 'Approved PRs for Hacktoberfest' },
              'good first issue': { color: '7057FF', description: 'Good for newcomers' },
              'help wanted': { color: '008672', description: 'Extra attention is needed' }
            };
            
            for (const label of missingLabels) {
              const config = labelConfigs[label];
              if (config) {
                try {
                  await github.rest.issues.createLabel({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    name: label,
                    color: config.color,
                    description: config.description
                  });
                  console.log(`âœ… Created missing label: ${label}`);
                } catch (error) {
                  console.error(`âŒ Failed to create label ${label}:`, error.message);
                }
              }
            }
          } else {
            console.log('âœ… All required labels are present');
          }
          
          // Check repository topics for hacktoberfest
          const { data: repo } = await github.rest.repos.get({
            owner: context.repo.owner,
            repo: context.repo.repo
          });
          
          const topics = repo.topics || [];
          if (!topics.includes('hacktoberfest')) {
            console.log('âš ï¸  Repository is missing "hacktoberfest" topic');
            try {
              const updatedTopics = [...new Set([...topics, 'hacktoberfest', 'competitive-programming', 'cses'])];
              await github.rest.repos.replaceAllTopics({
                owner: context.repo.owner,
                repo: context.repo.repo,
                names: updatedTopics
              });
              console.log('âœ… Added hacktoberfest topic to repository');
            } catch (error) {
              console.error('âŒ Failed to add hacktoberfest topic:', error.message);
            }
          } else {
            console.log('âœ… Repository has hacktoberfest topic');
          }
          
          // Validate workflow files syntax
          console.log('ğŸ” Validating workflow files...');
          
          const workflowFiles = [
            '.github/workflows/auto-label-hacktoberfest.yml',
            '.github/workflows/setup-labels.yml',
            '.github/workflows/hacktoberfest-pr-management.yml'
          ];
          
          console.log('âœ… Validation complete!');

    - name: Create validation report
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const now = new Date();
          const isOctober = now.getMonth() === 9; // October is month 9 (0-indexed)
          const currentYear = now.getFullYear();
          
          let reportTitle = `ğŸ” Hacktoberfest Setup Validation Report - ${now.toDateString()}`;
          if (isOctober) {
            reportTitle = `ğŸƒ ${reportTitle}`;
          }
          
          const reportBody = "## " + reportTitle + "\n\n" +
            "### ğŸ“Š Status Overview\n" +
            "- **Repository**: " + context.repo.owner + "/" + context.repo.repo + "\n" +
            "- **Validation Date**: " + now.toISOString() + "\n" +
            "- **Hacktoberfest Season**: " + (isOctober ? 'ğŸƒ Yes (October)' : 'âŒ No') + "\n" +
            "- **Current Year**: " + currentYear + "\n\n" +
            "### ğŸ·ï¸ Labels Status\n" +
            "All required Hacktoberfest labels have been validated and created if missing.\n\n" +
            "### ğŸ”§ Workflows Status\n" +
            "All Hacktoberfest automation workflows are active:\n" +
            "- âœ… Auto-label Issues & PRs\n" +
            "- âœ… Setup Repository Labels\n" +
            "- âœ… PR Management & Review Flow\n" +
            "- âœ… Validation & Monitoring\n\n" +
            "### ğŸ¯ Recommendations\n" +
            (isOctober ? 
              '- ğŸƒ Hacktoberfest is active! Promote your repository\n- ğŸ“¢ Share on social media with #Hacktoberfest\n- ğŸ‘¥ Engage with contributors and provide timely reviews' :
              '- ğŸ•’ Prepare for next Hacktoberfest season\n- ğŸ“ Update documentation and contribution guidelines\n- ğŸ·ï¸ Review and organize issues for the upcoming season'
            ) + "\n\n" +
            "### ğŸ“ˆ Next Steps\n" +
            "- Monitor workflow performance\n" +
            "- Review contributor activity\n" +
            "- Update labels and automation as needed\n\n" +
            "---\n" +
            "*This report was generated automatically by the Hacktoberfest validation workflow.*";
          
          console.log('ğŸ“‹ Validation Report Generated:');
          console.log(reportBody);